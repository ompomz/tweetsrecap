<!DOCTYPE html>
<html lang="ja">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Nostr Post Search Tool</title>
 <script src="https://unpkg.com/nostr-tools@1.17.0/lib/nostr.bundle.js"></script>
 <style>
 body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
 .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
 h1, h2 { color: #0056b3; }
 .input-group { margin-bottom: 15px; }
 .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
 .input-group input[type="text"], .input-group input[type="date"], .input-group textarea { width: calc(100% - 22px); padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
 textarea { resize: both; min-height: 100px; }
 button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; margin-right: 10px;}
 button:hover { background-color: #0056b3; }
 .button-group { margin-bottom: 15px; }
 #results { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
 .post { background-color: #f9f9f9; border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 6px; position: relative;}
 .post-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.9em; color: #555; }
 .post-header a { color: #007bff; text-decoration: none; }
 .post-header a:hover { text-decoration: underline; }
 .post-content { white-space: pre-wrap; word-wrap: break-word; margin-bottom: 10px;}
 .post-actions { text-align: right; }
 .post-actions button { padding: 5px 10px; font-size: 0.8em; margin-left: 5px; }
 #status { margin-top: 10px; font-weight: bold; color: #d9534f; }
 .copy-button { display: none; }
 .copy-button:hover { background-color: #5a6268; }
 .copy-all-button { margin-top: 10px; }
 #summary-section { margin-top: 20px; padding-top: 10px; border-top: 1px solid #eee; }
 </style>
</head>
<body>
 <div id="header-placeholder"></div>
 <script src="https://ompomz.github.io/header/loadHeader.js"></script>
 <div class="container">
 <h1>Nostr Post Search Tool</h1>
 <p>npubまたはNIP-05アドレスと日付を入力して、Kind:1の投稿を検索します。</p>

 <div class="input-group">
 <label for="npub">npub / NIP-05:</label>
 <input type="text" id="npub" placeholder="npub1... または user@example.com">
 </div>
 <div class="input-group">
 <label for="date">日付:</label>
 <input type="date" id="date">
 </div>
 
 <button onclick="searchPosts()">検索</button>

 <div id="summary-section">
 <h2>投稿のまとめ</h2>
 <div class="button-group">
 <button onclick="summarizePosts()" class="copy-all-button">まとめてコピー</button>
 </div>
 <textarea id="summarized-posts" readonly placeholder="ここに検索結果の投稿がまとめられます。"></textarea>
 </div>

 <div id="results">
 <h2>結果</h2>
 <div id="post-list"></div>
 <p id="status"></p>
 </div>
 </div>

 <script>
 // NostrToolsはグローバル変数として提供される (バージョン1.17.0の挙動)
 const RELAY_URL = 'wss://relay.nostr.band';
 let fetchedPosts = []; // 検索結果の投稿を保持する配列

 /**
 * NIP-05アドレスを解決して公開鍵を取得します。
 * @param {string} nip05 - NIP-05アドレス (例: user@example.com)
 * @returns {Promise<string|null>} 公開鍵のHEX文字列、または解決できなかった場合はnull
 */
 async function resolveNip05(nip05) {
 const parts = nip05.split('@');
 if (parts.length !== 2) return null;

 const [name, domain] = parts;
 try {
 const response = await fetch(`https://${domain}/.well-known/nostr.json?name=${name}`);
 const data = await response.json();
 return data.names[name] || null;
 } catch (e) {
 console.error(`NIP-05アドレスの解決に失敗しました: ${nip05}`, e);
 return null;
 }
 }

 /**
 * npub、HEX、またはNIP-05アドレスを公開鍵のHEX文字列に正規化します。
 * @param {string} input - npub、HEX、またはNIP-05アドレス
 * @returns {Promise<string|null>} 公開鍵のHEX文字列、または解決できなかった場合はnull
 */
 async function normalizePubkey(input) {
 if (input.startsWith("npub1")) {
 try {
 // NostrTools.nip19 を使用 (バージョン1.17.0の挙動)
 const { type, data } = NostrTools.nip19.decode(input); 
 if (type === 'npub') {
 return data;
 }
 } catch (e) {
 console.error("npubのデコードに失敗しました:", e);
 return null;
 }
 } else if (/^[a-f0-9]{64}$/i.test(input)) {
 return input;
 } else if (input.includes('@')) {
 return await resolveNip05(input);
 }
 return null;
 }

 // 投稿を検索し、表示するメイン関数
 const searchPosts = async () => {
 const npubInput = document.getElementById("npub").value.trim();
 const dateStr = document.getElementById("date").value;
 const postList = document.getElementById("post-list");
 const statusMessage = document.getElementById("status");
 const summarizedPostsArea = document.getElementById("summarized-posts");

 postList.innerHTML = '';
 statusMessage.textContent = '';
 summarizedPostsArea.value = ''; // 検索開始時にまとめエリアをクリア
 fetchedPosts = []; // 検索開始時に投稿配列をクリア

 if (!npubInput || !dateStr) {
 statusMessage.textContent = 'npubまたはNIP-05アドレスと日付の両方を入力してください。';
 return;
 }

 statusMessage.textContent = '検索中...';

 let pubkey;
 try {
 // npubInputを公開鍵（HEX）に正規化
 pubkey = await normalizePubkey(npubInput);
 if (!pubkey) {
 throw new Error('無効なnpub、NIP-05アドレス、または公開鍵形式です。');
 }
 } catch (e) {
 statusMessage.textContent = e.message;
 return;
 }
 
 // 指定日の00:00:00と23:59:59のUNIXタイムスタンプを計算
 const date = new Date(dateStr);
 if (isNaN(date.getTime())) {
 statusMessage.textContent = '無効な日付形式です。';
 return;
 }
 const sinceTime = Math.floor(date.setHours(0, 0, 0, 0) / 1000);
 const untilTime = Math.floor(date.setHours(23, 59, 59, 999) / 1000);

 try {
 // NostrTools.relayInit を使用 (バージョン1.17.0の挙動)
 const relay = NostrTools.relayInit(RELAY_URL); 
 relay.on('error', () => {
 statusMessage.textContent = 'リレーへの接続に失敗しました。';
 });
 await relay.connect();

 const kinds1Events = []; // Kind:1の投稿を格納
 const reactionEvents = []; // Kind:6, Kind:7を格納

 // Kind:1の投稿を検索
 const sub1 = relay.sub([
 {
 kinds: [1],
 authors: [pubkey],
 since: sinceTime,
 until: untilTime,
 }
 ]);

 sub1.on('event', (event) => {
 kinds1Events.push(event);
 });

 // Kind:6とKind:7のリアクションイベントを検索
 // njump.meのneventリンクを作成するために、関連するイベントIDを収集
 let eventIds = new Set();
 sub1.on('eose', () => {
 kinds1Events.forEach(e => eventIds.add(e.id));

 if (eventIds.size > 0) {
 const sub2 = relay.sub([
 {
 kinds: [6, 7],
 '#e': Array.from(eventIds),
 since: sinceTime,
 until: untilTime,
 }
 ]);

 sub2.on('event', (event) => {
 reactionEvents.push(event);
 });

 sub2.on('eose', () => {
 displayResults(kinds1Events, reactionEvents);
 relay.close();
 });
 } else {
 displayResults([], []);
 relay.close();
 }
 });

 } catch (e) {
 statusMessage.textContent = `エラーが発生しました: ${e.message}`;
 }
 };

 // 検索結果を表示する関数
 const displayResults = (posts, reactions) => {
 const postList = document.getElementById("post-list");
 const statusMessage = document.getElementById("status");
 fetchedPosts = posts; // 検索結果をグローバル変数に保存

 if (posts.length === 0) {
 statusMessage.textContent = '指定された日付の投稿は見つかりませんでした。';
 return;
 }

 // 投稿日時が古い順（昇順）にソート
 posts.sort((a, b) => a.created_at - b.created_at);

 // リアクション数を集計
 const reactionCounts = {};
 reactions.forEach(reaction => {
 const targetEventId = reaction.tags.find(tag => tag[0] === 'e')?.[1];
 if (targetEventId) {
 if (!reactionCounts[targetEventId]) {
 reactionCounts[targetEventId] = { reposts: 0, reactions: 0 };
 }
 if (reaction.kind === 6) {
 reactionCounts[targetEventId].reposts++;
 } else if (reaction.kind === 7) {
 reactionCounts[targetEventId].reactions++;
 }
 }
 });

 // 結果をHTMLにレンダリング
 posts.forEach(post => {
 const postElement = document.createElement('div');
 postElement.className = 'post';

 // 日時をフォーマット
 const postDate = new Date(post.created_at * 1000);
 const formattedDate = `${postDate.getFullYear()}/${(postDate.getMonth() + 1).toString().padStart(2, '0')}/${postDate.getDate().toString().padStart(2, '0')} ${postDate.getHours().toString().padStart(2, '0')}:${postDate.getMinutes().toString().padStart(2, '0')}:${postDate.getSeconds().toString().padStart(2, '0')}`;

 // neventリンクを作成
 const eventPointer = {
 id: post.id,
 relays: [RELAY_URL], // 検索に使用したリレーを含める
 author: post.pubkey, // 著者の公開鍵を含める
 };
 // NostrTools.nip19 を使用 (バージョン1.17.0の挙動)
 const nevent = NostrTools.nip19.neventEncode(eventPointer); 
 const njumpLink = `https://njump.me/${nevent}`;

 const counts = reactionCounts[post.id] || { reposts: 0, reactions: 0 };

 postElement.innerHTML = `
 <div class="post-header">
 <a href="${njumpLink}" target="_blank">${formattedDate}</a>
 <span>🔁${counts.reposts} ⭐${counts.reactions}</span>
 </div>
 <div class="post-content">${escapeHtml(post.content)}</div>
 <div class="post-actions">
 <button onclick="copyToClipboard('${escapeHtml(post.content)}')">投稿をコピー</button>
 </div>
 `;
 postList.appendChild(postElement);
 });

 statusMessage.textContent = `検索完了。${posts.length}件の投稿が見つかりました。`;
 };

 // HTMLエスケープ関数
 const escapeHtml = (text) => {
 const div = document.createElement('div');
 div.textContent = text;
 return div.innerHTML;
 };

 // クリップボードにコピーする関数
 const copyToClipboard = (text) => {
 navigator.clipboard.writeText(text).then(() => {
 alert('投稿内容をコピーしました！');
 }).catch(err => {
 console.error('コピーに失敗しました:', err);
 });
 };

 // 投稿をまとめてコピーする関数
 const summarizePosts = () => {
 const summarizedPostsArea = document.getElementById("summarized-posts");
 if (fetchedPosts.length === 0) {
 summarizedPostsArea.value = "まとめる投稿がありません。まず投稿を検索してください。";
 return;
 }

 const summary = fetchedPosts.map(post => {
 const postDate = new Date(post.created_at * 1000);
 const formattedDate = `${postDate.getFullYear()}/${(postDate.getMonth() + 1).toString().padStart(2, '0')}/${postDate.getDate().toString().padStart(2, '0')} ${postDate.getHours().toString().padStart(2, '0')}:${postDate.getMinutes().toString().padStart(2, '0')}:${postDate.getSeconds().toString().padStart(2, '0')}`;
 return `[${formattedDate}]\n${post.content}`;
 }).join('\n\n---\n\n'); // 各投稿を区切る

 summarizedPostsArea.value = summary;
 
 // コピー機能を追加
 navigator.clipboard.writeText(summary).then(() => {
 alert('すべての投稿をまとめてコピーしました！');
 }).catch(err => {
 console.error('まとめてコピーに失敗しました:', err);
 });
 };

 // ページ読み込み時に今日の日付を設定する
 document.addEventListener('DOMContentLoaded', () => {
 const dateInput = document.getElementById('date');
 const today = new Date();
 const year = today.getFullYear();
 const month = String(today.getMonth() + 1).padStart(2, '0'); // 月は0から始まるため+1
 const day = String(today.getDate()).padStart(2, '0');
 dateInput.value = `${year}-${month}-${day}`;
 });
 </script>
</body>
</html>
