<!DOCTYPE html>
<html lang="ja">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Nostr Post Search Tool</title>
 <script src="https://unpkg.com/nostr-tools@1.17.0/lib/nostr.bundle.js"></script>
 <style>
 body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
 .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
 h1, h2 { color: #0056b3; }
 .input-group { margin-bottom: 15px; }
 .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
 .input-group input[type="text"], .input-group input[type="date"], .input-group textarea { width: calc(100% - 22px); padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
 textarea { resize: both; min-height: 100px; }
 button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; margin-right: 10px;}
 button:hover { background-color: #0056b3; }
 .button-group { margin-bottom: 15px; }
 #results { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
 .post { background-color: #f9f9f9; border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 6px; position: relative;}
 .post-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.9em; color: #555; }
 .post-header a { color: #007bff; text-decoration: none; }
 .post-header a:hover { text-decoration: underline; }
 .post-content { white-space: pre-wrap; word-wrap: break-word; margin-bottom: 10px;}
 .post-actions { text-align: right; }
 .post-actions button { padding: 5px 10px; font-size: 0.8em; margin-left: 5px; }
 #status { margin-top: 10px; font-weight: bold; color: #d9534f; }
 .copy-button { display: none; }
 .copy-button:hover { background-color: #5a6268; }
 .copy-all-button { margin-top: 10px; }
 #summary-section { margin-top: 20px; padding-top: 10px; border-top: 1px solid #eee; }
 </style>
</head>
<body>
 <div id="header-placeholder"></div>
 <script src="https://ompomz.github.io/header/loadHeader.js"></script>
 <div class="container">
 <h1>Nostr Post Search Tool</h1>
 <p>npubã¾ãŸã¯NIP-05ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ã€Kind:1ã®æŠ•ç¨¿ã‚’æ¤œç´¢ã—ã¾ã™ã€‚</p>

 <div class="input-group">
 <label for="npub">npub / NIP-05:</label>
 <input type="text" id="npub" placeholder="npub1... ã¾ãŸã¯ user@example.com">
 </div>
 <div class="input-group">
 <label for="date">æ—¥ä»˜:</label>
 <input type="date" id="date">
 </div>
 
 <button onclick="searchPosts()">æ¤œç´¢</button>

 <div id="summary-section">
 <h2>æŠ•ç¨¿ã®ã¾ã¨ã‚</h2>
 <div class="button-group">
 <button onclick="summarizePosts()" class="copy-all-button">ã¾ã¨ã‚ã¦ã‚³ãƒ”ãƒ¼</button>
 </div>
 <textarea id="summarized-posts" readonly placeholder="ã“ã“ã«æ¤œç´¢çµæœã®æŠ•ç¨¿ãŒã¾ã¨ã‚ã‚‰ã‚Œã¾ã™ã€‚"></textarea>
 </div>

 <div id="results">
 <h2>çµæœ</h2>
 <div id="post-list"></div>
 <p id="status"></p>
 </div>
 </div>

 <script>
 // NostrToolsã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦æä¾›ã•ã‚Œã‚‹ (ãƒãƒ¼ã‚¸ãƒ§ãƒ³1.17.0ã®æŒ™å‹•)
 const RELAY_URL = 'wss://relay.nostr.band';
 let fetchedPosts = []; // æ¤œç´¢çµæœã®æŠ•ç¨¿ã‚’ä¿æŒã™ã‚‹é…åˆ—

 /**
 * NIP-05ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è§£æ±ºã—ã¦å…¬é–‹éµã‚’å–å¾—ã—ã¾ã™ã€‚
 * @param {string} nip05 - NIP-05ã‚¢ãƒ‰ãƒ¬ã‚¹ (ä¾‹: user@example.com)
 * @returns {Promise<string|null>} å…¬é–‹éµã®HEXæ–‡å­—åˆ—ã€ã¾ãŸã¯è§£æ±ºã§ããªã‹ã£ãŸå ´åˆã¯null
 */
 async function resolveNip05(nip05) {
 const parts = nip05.split('@');
 if (parts.length !== 2) return null;

 const [name, domain] = parts;
 try {
 const response = await fetch(`https://${domain}/.well-known/nostr.json?name=${name}`);
 const data = await response.json();
 return data.names[name] || null;
 } catch (e) {
 console.error(`NIP-05ã‚¢ãƒ‰ãƒ¬ã‚¹ã®è§£æ±ºã«å¤±æ•—ã—ã¾ã—ãŸ: ${nip05}`, e);
 return null;
 }
 }

 /**
 * npubã€HEXã€ã¾ãŸã¯NIP-05ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¬é–‹éµã®HEXæ–‡å­—åˆ—ã«æ­£è¦åŒ–ã—ã¾ã™ã€‚
 * @param {string} input - npubã€HEXã€ã¾ãŸã¯NIP-05ã‚¢ãƒ‰ãƒ¬ã‚¹
 * @returns {Promise<string|null>} å…¬é–‹éµã®HEXæ–‡å­—åˆ—ã€ã¾ãŸã¯è§£æ±ºã§ããªã‹ã£ãŸå ´åˆã¯null
 */
 async function normalizePubkey(input) {
 if (input.startsWith("npub1")) {
 try {
 // NostrTools.nip19 ã‚’ä½¿ç”¨ (ãƒãƒ¼ã‚¸ãƒ§ãƒ³1.17.0ã®æŒ™å‹•)
 const { type, data } = NostrTools.nip19.decode(input); 
 if (type === 'npub') {
 return data;
 }
 } catch (e) {
 console.error("npubã®ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
 return null;
 }
 } else if (/^[a-f0-9]{64}$/i.test(input)) {
 return input;
 } else if (input.includes('@')) {
 return await resolveNip05(input);
 }
 return null;
 }

 // æŠ•ç¨¿ã‚’æ¤œç´¢ã—ã€è¡¨ç¤ºã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
 const searchPosts = async () => {
 const npubInput = document.getElementById("npub").value.trim();
 const dateStr = document.getElementById("date").value;
 const postList = document.getElementById("post-list");
 const statusMessage = document.getElementById("status");
 const summarizedPostsArea = document.getElementById("summarized-posts");

 postList.innerHTML = '';
 statusMessage.textContent = '';
 summarizedPostsArea.value = ''; // æ¤œç´¢é–‹å§‹æ™‚ã«ã¾ã¨ã‚ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
 fetchedPosts = []; // æ¤œç´¢é–‹å§‹æ™‚ã«æŠ•ç¨¿é…åˆ—ã‚’ã‚¯ãƒªã‚¢

 if (!npubInput || !dateStr) {
 statusMessage.textContent = 'npubã¾ãŸã¯NIP-05ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨æ—¥ä»˜ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
 return;
 }

 statusMessage.textContent = 'æ¤œç´¢ä¸­...';

 let pubkey;
 try {
 // npubInputã‚’å…¬é–‹éµï¼ˆHEXï¼‰ã«æ­£è¦åŒ–
 pubkey = await normalizePubkey(npubInput);
 if (!pubkey) {
 throw new Error('ç„¡åŠ¹ãªnpubã€NIP-05ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã¾ãŸã¯å…¬é–‹éµå½¢å¼ã§ã™ã€‚');
 }
 } catch (e) {
 statusMessage.textContent = e.message;
 return;
 }
 
 // æŒ‡å®šæ—¥ã®00:00:00ã¨23:59:59ã®UNIXã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¨ˆç®—
 const date = new Date(dateStr);
 if (isNaN(date.getTime())) {
 statusMessage.textContent = 'ç„¡åŠ¹ãªæ—¥ä»˜å½¢å¼ã§ã™ã€‚';
 return;
 }
 const sinceTime = Math.floor(date.setHours(0, 0, 0, 0) / 1000);
 const untilTime = Math.floor(date.setHours(23, 59, 59, 999) / 1000);

 try {
 // NostrTools.relayInit ã‚’ä½¿ç”¨ (ãƒãƒ¼ã‚¸ãƒ§ãƒ³1.17.0ã®æŒ™å‹•)
 const relay = NostrTools.relayInit(RELAY_URL); 
 relay.on('error', () => {
 statusMessage.textContent = 'ãƒªãƒ¬ãƒ¼ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
 });
 await relay.connect();

 const kinds1Events = []; // Kind:1ã®æŠ•ç¨¿ã‚’æ ¼ç´
 const reactionEvents = []; // Kind:6, Kind:7ã‚’æ ¼ç´

 // Kind:1ã®æŠ•ç¨¿ã‚’æ¤œç´¢
 const sub1 = relay.sub([
 {
 kinds: [1],
 authors: [pubkey],
 since: sinceTime,
 until: untilTime,
 }
 ]);

 sub1.on('event', (event) => {
 kinds1Events.push(event);
 });

 // Kind:6ã¨Kind:7ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œç´¢
 // njump.meã®neventãƒªãƒ³ã‚¯ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ã€é–¢é€£ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’åé›†
 let eventIds = new Set();
 sub1.on('eose', () => {
 kinds1Events.forEach(e => eventIds.add(e.id));

 if (eventIds.size > 0) {
 const sub2 = relay.sub([
 {
 kinds: [6, 7],
 '#e': Array.from(eventIds),
 since: sinceTime,
 until: untilTime,
 }
 ]);

 sub2.on('event', (event) => {
 reactionEvents.push(event);
 });

 sub2.on('eose', () => {
 displayResults(kinds1Events, reactionEvents);
 relay.close();
 });
 } else {
 displayResults([], []);
 relay.close();
 }
 });

 } catch (e) {
 statusMessage.textContent = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`;
 }
 };

 // æ¤œç´¢çµæœã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
 const displayResults = (posts, reactions) => {
 const postList = document.getElementById("post-list");
 const statusMessage = document.getElementById("status");
 fetchedPosts = posts; // æ¤œç´¢çµæœã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜

 if (posts.length === 0) {
 statusMessage.textContent = 'æŒ‡å®šã•ã‚ŒãŸæ—¥ä»˜ã®æŠ•ç¨¿ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
 return;
 }

 // æŠ•ç¨¿æ—¥æ™‚ãŒå¤ã„é †ï¼ˆæ˜‡é †ï¼‰ã«ã‚½ãƒ¼ãƒˆ
 posts.sort((a, b) => a.created_at - b.created_at);

 // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°ã‚’é›†è¨ˆ
 const reactionCounts = {};
 reactions.forEach(reaction => {
 const targetEventId = reaction.tags.find(tag => tag[0] === 'e')?.[1];
 if (targetEventId) {
 if (!reactionCounts[targetEventId]) {
 reactionCounts[targetEventId] = { reposts: 0, reactions: 0 };
 }
 if (reaction.kind === 6) {
 reactionCounts[targetEventId].reposts++;
 } else if (reaction.kind === 7) {
 reactionCounts[targetEventId].reactions++;
 }
 }
 });

 // çµæœã‚’HTMLã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
 posts.forEach(post => {
 const postElement = document.createElement('div');
 postElement.className = 'post';

 // æ—¥æ™‚ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
 const postDate = new Date(post.created_at * 1000);
 const formattedDate = `${postDate.getFullYear()}/${(postDate.getMonth() + 1).toString().padStart(2, '0')}/${postDate.getDate().toString().padStart(2, '0')} ${postDate.getHours().toString().padStart(2, '0')}:${postDate.getMinutes().toString().padStart(2, '0')}:${postDate.getSeconds().toString().padStart(2, '0')}`;

 // neventãƒªãƒ³ã‚¯ã‚’ä½œæˆ
 const eventPointer = {
 id: post.id,
 relays: [RELAY_URL], // æ¤œç´¢ã«ä½¿ç”¨ã—ãŸãƒªãƒ¬ãƒ¼ã‚’å«ã‚ã‚‹
 author: post.pubkey, // è‘—è€…ã®å…¬é–‹éµã‚’å«ã‚ã‚‹
 };
 // NostrTools.nip19 ã‚’ä½¿ç”¨ (ãƒãƒ¼ã‚¸ãƒ§ãƒ³1.17.0ã®æŒ™å‹•)
 const nevent = NostrTools.nip19.neventEncode(eventPointer); 
 const njumpLink = `https://njump.me/${nevent}`;

 const counts = reactionCounts[post.id] || { reposts: 0, reactions: 0 };

 postElement.innerHTML = `
 <div class="post-header">
 <a href="${njumpLink}" target="_blank">${formattedDate}</a>
 <span>ğŸ”${counts.reposts} â­${counts.reactions}</span>
 </div>
 <div class="post-content">${escapeHtml(post.content)}</div>
 <div class="post-actions">
 <button onclick="copyToClipboard('${escapeHtml(post.content)}')">æŠ•ç¨¿ã‚’ã‚³ãƒ”ãƒ¼</button>
 </div>
 `;
 postList.appendChild(postElement);
 });

 statusMessage.textContent = `æ¤œç´¢å®Œäº†ã€‚${posts.length}ä»¶ã®æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚`;
 };

 // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
 const escapeHtml = (text) => {
 const div = document.createElement('div');
 div.textContent = text;
 return div.innerHTML;
 };

 // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹é–¢æ•°
 const copyToClipboard = (text) => {
 navigator.clipboard.writeText(text).then(() => {
 alert('æŠ•ç¨¿å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
 }).catch(err => {
 console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
 });
 };

 // æŠ•ç¨¿ã‚’ã¾ã¨ã‚ã¦ã‚³ãƒ”ãƒ¼ã™ã‚‹é–¢æ•°
 const summarizePosts = () => {
 const summarizedPostsArea = document.getElementById("summarized-posts");
 if (fetchedPosts.length === 0) {
 summarizedPostsArea.value = "ã¾ã¨ã‚ã‚‹æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšæŠ•ç¨¿ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚";
 return;
 }

 const summary = fetchedPosts.map(post => {
 const postDate = new Date(post.created_at * 1000);
 const formattedDate = `${postDate.getFullYear()}/${(postDate.getMonth() + 1).toString().padStart(2, '0')}/${postDate.getDate().toString().padStart(2, '0')} ${postDate.getHours().toString().padStart(2, '0')}:${postDate.getMinutes().toString().padStart(2, '0')}:${postDate.getSeconds().toString().padStart(2, '0')}`;
 return `[${formattedDate}]\n${post.content}`;
 }).join('\n\n---\n\n'); // å„æŠ•ç¨¿ã‚’åŒºåˆ‡ã‚‹

 summarizedPostsArea.value = summary;
 
 // ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã‚’è¿½åŠ 
 navigator.clipboard.writeText(summary).then(() => {
 alert('ã™ã¹ã¦ã®æŠ•ç¨¿ã‚’ã¾ã¨ã‚ã¦ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
 }).catch(err => {
 console.error('ã¾ã¨ã‚ã¦ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
 });
 };

 // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®šã™ã‚‹
 document.addEventListener('DOMContentLoaded', () => {
 const dateInput = document.getElementById('date');
 const today = new Date();
 const year = today.getFullYear();
 const month = String(today.getMonth() + 1).padStart(2, '0'); // æœˆã¯0ã‹ã‚‰å§‹ã¾ã‚‹ãŸã‚+1
 const day = String(today.getDate()).padStart(2, '0');
 dateInput.value = `${year}-${month}-${day}`;
 });
 </script>
</body>
</html>
