<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tweets recap</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; padding: 0.5rem; line-height: 1.3; background-color: #f7f7f7; color: #666; font-size: 0.9rem; }
        .container { max-width: 600px; margin: 0rem auto 0rem 0.5rem; padding: 0.5rem; border-radius: 4px; background-color: #f7f7f7; }
        @media (max-width: 767px) { .container { max-width: 100%; padding: 0.5rem; margin: 0; } }
        h1 { font-size: 1.1rem; color: #666; display: inline; }
        h2 { font-size: 0.9rem; color: #666; display: inline; }
        .input-group { margin: 0.5rem 0; display: flex; gap: 0.3rem; flex-wrap: nowrap; align-items: center; }
        input[type="text"], input[type="date"], textarea { padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; color: #666; flex-shrink: 1; min-width: 0; }
        input[type="text"] { flex-grow: 1; }
        .container button { margin: 0; border: none; font-size: 0.8rem; padding: 0.5rem 0.8rem; border-radius: 999px; font-weight: bold; cursor: pointer; background-color: #ffb366; color: #fff; transition: background-color 0.3s ease, color 0.3s ease; flex-shrink: 1; min-width: 0; }
        .container button:hover { background-color: #ffa347; }
        #summary-section { border-top: 1px solid #ddd; display: flex; align-items: center; gap: 0.5rem; }
        #summary-section button{ font-size: 0.7rem; padding: 0.3rem 0.7rem; }
        .summary-header { display: flex; flex-direction: column; justify-content: center; gap: 0.25rem; margin: 0.5rem 0rem; }
        #summarized-posts { flex-grow: 1; min-height: 3rem; font-size: 0.8rem; resize: vertical; }
        #results { border-top: 1px solid #ddd; }
        .post-line { font-size: 0.9rem; padding: 0.5rem 0; border-bottom: 1px dashed #ddd; word-wrap: break-word; overflow-wrap: break-word; }
        .post-time { color: #66b3ff; text-decoration: none; }
        .post-time:hover { text-decoration: underline; color: #4da6ff; }
        #status { margin-top: 0.5rem; font-weight: bold; color: #ff99cc; }
 .modal{display:none;position:fixed;z-index:1;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.2);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);}
 .modal-content{margin:auto;display:block;max-width:80%;max-height:80vh;width:80%;}
 .modal-image{width:auto;height:auto;max-width:100%;max-height:100%;object-fit:contain;display:block;margin:auto;}
 .close-button{color:#fff;font-size:40px;font-weight:700;cursor:pointer;transition:0.3s;}
 .close-button:hover,.close-button:focus{color:#eee;text-decoration:none;cursor:pointer;}
</style>
</head>
<body>
    <div id="header-placeholder"></div>
    <div class="container">
        <div class="header-content" style="display:flex; flex-wrap:wrap; align-items:center; gap:1rem;">
            <h1>tweets recap</h1>
            <p>その日のkind:1を表示します</p>
        </div>
        <div class="input-group">
            <label for="npub" style="display:none;">pubkey</label>
            <input type="text" id="npub" placeholder="npub1... or NIP-05" style="flex-grow: 1;">
            <label for="date" style="display:none;">date</label>
            <input type="date" id="date">
            <button onclick="searchPosts()">recap</button>
            <button onclick="createShareLink()">share</button>
        </div>
        <div id="summary-section">
            <div class="summary-header">
                <h2 style="display:none;">まとめ</h2>
                <button onclick="summarizePosts()">まとめる</button>
                <button onclick="copySummarizedPosts()">コピーする</button>
            </div>
            <textarea id="summarized-posts" readonly placeholder="ちゃぴに投げる用"></textarea>
        </div>
        <div id="results">
            <div id="post-list"></div>
            <p id="status"></p>
        </div>
    </div>
    <div id="modal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><img id="modal-image" class="modal-image" src="" alt="拡大画像"></div></div>
    <script>
    // ドキュメントが完全に読み込まれてから実行する
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('modal');
        const closeButton = document.querySelector('.close-button');

        // 閉じるボタンがクリックされたらモーダルを閉じる
        closeButton.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        // モーダルの背景部分をクリックしたときに閉じる
        modal.addEventListener('click', (event) => {
            // クリックされた要素がモーダル自体であれば閉じる
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    });

    // openModal関数は外部から呼び出せるようにそのまま残す
    function openModal(imageUrl){
        const modal = document.getElementById('modal');
        const modalImage = document.getElementById('modal-image');
        modal.style.display = 'block';
        modalImage.src = imageUrl;
    }
</script>
    <script src="https://unpkg.com/nostr-tools@1.17.0/lib/nostr.bundle.js"></script>
    <script>
        let RELAY_URL='wss://relay.nostr.band';
        async function checkRelay(url){
            try{
                const relay=NostrTools.relayInit(url);
                await relay.connect();
                relay.close();
                return!0
            }catch(e){
                console.warn(`[Relay Check] ${url} に接続できませんでした。`,e);
                return!1
            }
        }
        (async()=>{
            const isMainAlive=await checkRelay(RELAY_URL);
            if(!isMainAlive){
                console.warn(`[Relay Fallback] nostr.band が死んでるので nos.lol に切り替えます。`);
                RELAY_URL='wss://nos.lol'
            }
        })();
        let fetchedPosts=[];
        const reactionCache=new Map();
        const postElements=new Map();
        const reactionUpdateInterval=5000;
        async function resolveNip05(nip05){
            const parts=nip05.split('@');
            if(parts.length!==2)return null;
            const[name,domain]=parts;
            try{
                const response=await fetch(`https://${domain}/.well-known/nostr.json?name=${name}`);
                const data=await response.json();
                return data.names[name]||null
            }catch(e){
                console.error(`NIP-05アドレスの解決に失敗しました: ${nip05}`,e);
                return null
            }
        }
        async function normalizePubkey(input){
            if(input.startsWith("npub1")){
                try{
                    const{type,data}=NostrTools.nip19.decode(input);
                    if(type==='npub'){
                        return data
                    }
                }catch(e){
                    console.error("npubのデコードに失敗しました:",e);
                    return null
                }
            }else if(/^[a-f0-9]{64}$/i.test(input)){
                return input
            }else if(input.includes('@')){
                return await resolveNip05(input)
            }
            return null
        }
        const renderPostsAndReactions=(posts,reactions,isInitialDraw)=>{
            const postList=document.getElementById("post-list");
            const statusMessage=document.getElementById("status");
            const reactionCounts={};
            reactions.forEach(reaction=>{
                const targetEventId=reaction.tags.find(tag=>tag[0]==='e')?.[1];
                if(targetEventId){
                    if(!reactionCounts[targetEventId]){
                        reactionCounts[targetEventId]={reposts:0,reactions:0}
                    }
                    if(reaction.kind===6){
                        reactionCounts[targetEventId].reposts++
                    }else if(reaction.kind===7){
                        reactionCounts[targetEventId].reactions++
                    }
                }
            });
            if(isInitialDraw){
                fetchedPosts=posts;
                postList.innerHTML='';
                postElements.clear();
                if(posts.length===0){
                    statusMessage.textContent='指定された日付の投稿は見つかりませんでした。';
                    return
                }
                posts.sort((a,b)=>a.created_at-b.created_at);
                console.log(`[Rendering] 投稿 ${posts.length} 件を初回描画します。`);
                posts.forEach(post=>{
                    const postElement=document.createElement('div');
                    postElement.className='post';
                    postElement.dataset.eventId=post.id;
                    const postDate=new Date(post.created_at*1000);
                    const formattedDate=`${(postDate.getMonth() + 1).toString().padStart(2, '0')}/${postDate.getDate().toString().padStart(2, '0')} ${postDate.getHours().toString().padStart(2, '0')}:${postDate.getMinutes().toString().padStart(2, '0')}`;
                    const eventPointer={
                        id:post.id,
                        relays:[RELAY_URL],
                        author:post.pubkey,
                    };
                    const nevent=NostrTools.nip19.neventEncode(eventPointer);
                    const customViewerUrl=`/tweetsrecap/tweet?id=${nevent}`;
                    postElement.innerHTML=`
                        <div class="post-line">
                            <a href="${customViewerUrl}" target="_blank" class="post-time">[${formattedDate}]</a>
                            ${linkifyAndEscapeHtml(post.content)}
                            <span class="reaction-counts"></span>
                        </div>
                    `;
                    postList.appendChild(postElement);
                    postElements.set(post.id,postElement)
                })
            }
            posts.forEach(post=>{
                const counts=reactionCounts[post.id]||{reposts:0,reactions:0};
                const postElement=postElements.get(post.id);
                if(postElement){
                    const reactionSpan=postElement.querySelector('.reaction-counts');
                    if(reactionSpan){
                        reactionSpan.innerHTML=(counts.reactions>0||counts.reposts>0)?` ${counts.reactions > 0 ? ` ⭐${counts.reactions}` : ''}${counts.reposts > 0 ? ` 🔁${counts.reposts}` : ''} `:''
                    }
                }
            });
            statusMessage.textContent=`この日の投稿数：${posts.length}ツイート`
        };
        const searchPosts=async()=>{
            const npubInput=document.getElementById("npub").value.trim();
            const dateStr=document.getElementById("date").value;
            const statusMessage=document.getElementById("status");
            const summarizedPostsArea=document.getElementById("summarized-posts");
            document.getElementById("post-list").innerHTML='';
            statusMessage.textContent='検索中...';
            summarizedPostsArea.value='';
            fetchedPosts=[];
            reactionCache.clear();
            postElements.clear();
            if(!npubInput||!dateStr){
                statusMessage.textContent='npubまたはNIP-05アドレスと日付の両方を入力してください。';
                return
            }
            let pubkey;
            try{
                pubkey=await normalizePubkey(npubInput);
                if(!pubkey){
                    throw new Error('無効なnpub、NIP-05アドレス、または公開鍵形式です。')
                }
            }catch(e){
                statusMessage.textContent=e.message;
                return
            }
            const date=new Date(dateStr);
            if(isNaN(date.getTime())){
                statusMessage.textContent='無効な日付形式です。';
                return
            }
            const sinceTime=Math.floor(date.setHours(0,0,0,0)/1000);
            const untilTime=Math.floor(date.setHours(23,59,59,999)/1000);
            console.log(`[Step 1] メインリレーから kind:1, 42 のイベントを検索します...`);
            try{
                const kinds1And42Events=await fetchPosts(RELAY_URL,pubkey,sinceTime,untilTime);
                const eventIds=kinds1And42Events.map(e=>e.id);
                renderPostsAndReactions(kinds1And42Events,[],!0);
                if(eventIds.length>0){
                    fetchReactionsInBackground(pubkey,eventIds,sinceTime,untilTime)
                }
            }catch(e){
                statusMessage.textContent=`エラーが発生しました: ${e.message}`;
                console.error('[Fatal Error]',e)
            }
        };
        const fetchPosts=async(relayUrl,pubkey,sinceTime,untilTime)=>{
            const events=[];
            try{
                const relay=NostrTools.relayInit(relayUrl);
                await relay.connect();
                const sub=relay.sub([{
                    kinds:[1,42],
                    authors:[pubkey],
                    since:sinceTime,
                    until:untilTime,
                }]);
                return new Promise((resolve,reject)=>{
                    sub.on('event',(event)=>{
                        events.push(event)
                    });
                    sub.on('eose',()=>{
                        relay.close();
                        console.log(`[FetchPosts] 投稿の検索が完了しました。投稿数: ${events.length}件。`);
                        resolve(events)
                    });
                    setTimeout(()=>{
                        relay.close();
                        resolve(events)
                    },5000)
                })
            }catch(e){
                console.error(`[FetchPosts] リレー ${relayUrl} への接続または購読に失敗しました:`,e);
                return events
            }
        };
        const fetchReactionsInBackground=async(pubkey,eventIds,sinceTime,untilTime)=>{
            let relayUrlsToSearch=new Set();
            console.log(`[Background] Kind:10002イベントからフォローしているリレーリストを取得します...`);
            try{
                const mainRelay=NostrTools.relayInit(RELAY_URL);
                await mainRelay.connect();
                const sub10002=mainRelay.sub([{
                    kinds:[10002],
                    authors:[pubkey],
                    limit:1
                }]);
                const kind10002Event=await new Promise(resolve=>{
                    sub10002.on('event',(event)=>{
                        resolve(event)
                    });
                    sub10002.on('eose',()=>{
                        resolve(null)
                    });
                    setTimeout(()=>{
                        resolve(null)
                    },3000)
                });
                mainRelay.close();
                if(kind10002Event){
                    kind10002Event.tags.forEach(tag=>{
                        if(tag[0]==='r'&&tag[1].startsWith('wss://')){
                            relayUrlsToSearch.add(tag[1])
                        }
                    });
                    console.log(`[Background] Kind:10002イベントの購読が完了しました。検索対象リレーは以下の通りです:`,Array.from(relayUrlsToSearch))
                }else{
                    console.log(`[Background] Kind:10002イベントが見つかりませんでした。メインリレーを使用します。`)
                }
            }catch(e){
                console.error(`[Background] Kind:10002の取得に失敗しました。メインリレーを使用します:`,e)
            }
            if(relayUrlsToSearch.size===0){
                relayUrlsToSearch.add(RELAY_URL)
            }
            const untilNow=Math.floor(Date.now()/1000);
            const reactionRelayPromises=Array.from(relayUrlsToSearch).map(relayUrl=>{
                return new Promise(async(resolve)=>{
                    try{
                        const reactionRelay=NostrTools.relayInit(relayUrl);
                        await reactionRelay.connect();
                        const sub=reactionRelay.sub([{
                            kinds:[6,7],
                            '#e':eventIds,
                            since:sinceTime,
                            until:untilNow,
                        }]);
                        sub.on('event',(event)=>{
                            reactionCache.set(event.id,event)
                        });
                        sub.on('eose',()=>{
                            reactionRelay.close();
                            resolve()
                        })
                    }catch(e){
                        console.error(`[Background] リアクション取得用リレー ${relayUrl} への接続に失敗しました。`,e);
                        resolve()
                    }
                })
            });
            await Promise.all(reactionRelayPromises);
            renderPostsAndReactions(fetchedPosts,Array.from(reactionCache.values()),!1);
            console.log(`[Background] すべてのリレーからのリアクションイベントの初期取得が完了しました。`)
        };
        const escapeHtml=(text)=>{
            const div=document.createElement('div');
            div.textContent=text;
            return div.innerHTML
        };
        document.addEventListener('DOMContentLoaded',()=>{
            const dateInput=document.getElementById('date');
            const today=new Date();
            const year=today.getFullYear();
            const month=String(today.getMonth()+1).padStart(2,'0');
            const day=String(today.getDate()).padStart(2,'0');
            dateInput.value=`${year}-${month}-${day}`
        });
        document.addEventListener('DOMContentLoaded',()=>{
            const urlParams=new URLSearchParams(window.location.search);
            const npubFromUrl=urlParams.get('npub');
            const dateFromUrl=urlParams.get('date');
            if(npubFromUrl&&dateFromUrl){
                document.getElementById("npub").value=npubFromUrl;
                document.getElementById("date").value=dateFromUrl;
                searchPosts()
            }
        });
        const createShareLink=()=>{
            const npub=document.getElementById("npub").value;
            const date=document.getElementById("date").value;
            if(!npub||!date){
                alert("先にnpubと日付を入力してください。");
                return
            }
            const shareUrl=`${window.location.origin}${window.location.pathname}?npub=${encodeURIComponent(npub)}&date=${encodeURIComponent(date)}`;
            navigator.clipboard.writeText(shareUrl).then(()=>{
                alert('シェアリンクをコピーしました！')
            }).catch(err=>{
                console.error('コピーに失敗しました:',err)
            })
        };
        const summarizePosts=()=>{
            const summarizedPostsArea=document.getElementById("summarized-posts");
            if(fetchedPosts.length===0){
                alert("先にツイートを表示してください。");
                return
            }
            const summary=fetchedPosts.map(post=>{
                const postDate=new Date(post.created_at*1000);
                const formattedDate=`${postDate.getFullYear()}/${(postDate.getMonth() + 1).toString().padStart(2, '0')}/${postDate.getDate().toString().padStart(2, '0')} ${postDate.getHours().toString().padStart(2, '0')}:${postDate.getMinutes().toString().padStart(2, '0')}:${postDate.getSeconds().toString().padStart(2, '0')}`;
                return `[${formattedDate}]\n${post.content}`
            }).join('\n---\n');
            summarizedPostsArea.value=summary
        };
        const copySummarizedPosts=()=>{
            const text=document.getElementById("summarized-posts").value;
            if(!text.trim()){
                alert("先にまとめてください。");
                return
            }
            navigator.clipboard.writeText(text).then(()=>{
                alert('まとめをコピーしました！')
            }).catch(err=>{
                console.error('コピーに失敗しました:',err)
            })
        };
        /**
        * テキスト内のURLをリンクに変換し、HTMLエスケープも行います。
        * @param {string} text - 処理対象のテキスト
        * @returns {string} リンク化されたHTML文字列
        */
        const linkifyAndEscapeHtml=(text)=>{
            const escapedText=escapeHtml(text);
            const urlRegex=/(https?:\/\/[^\s]+)/g;
            return escapedText.replace(urlRegex,(url)=>{
                if(/\.(png|jpe?g|gif|webp|svg|heic|avif)$/i.test(url)){
                    return `<a href="#" onclick="event.preventDefault(); openModal('${url}')">${url}</a>`
                }
                return `<a href="${url}" target="_blank">${url}</a>`
            })
        };
    </script>
    <script src="https://ompomz.github.io/header/loadHeader.js"></script>
</body>
</html>
